blueprint:
  name: Gestion Intelligente Charge Batterie Enphase (Tempo + MÃ©tÃ©o)
  description: >
    GÃ¨re automatiquement la charge de la batterie Enphase en fonction :
    - Des heures creuses (optimisation tarifaire)
    - Des jours EDF Tempo (charge Ã  100% avant jours rouges)
    - De la mÃ©tÃ©o Ã  venir (production solaire prÃ©vue)
    - De l'Ã©tat de charge actuel de la batterie


    **FonctionnalitÃ©s :**
    - âš¡ Active la charge depuis le rÃ©seau en heures creuses
    - ğŸ”´ Charge forcÃ©e Ã  100% avant les jours rouges Tempo
    - â˜€ï¸ DÃ©sactive la charge si mÃ©tÃ©o favorable (production solaire suffisante)
    - ğŸ”‹ Optimise selon le SOC (State of Charge) actuel

  domain: automation
  source_url: https://github.com/foXaCe/enphase-battery/blob/main/blueprints/smart_battery_charge_tempo.yaml

  input:
    battery_soc_sensor:
      name: Capteur SOC Batterie
      description: Capteur indiquant le pourcentage de charge de la batterie (0-100%)
      selector:
        entity:
          filter:
            - domain: sensor
              device_class: battery

    charge_from_grid_switch:
      name: Switch Charge depuis RÃ©seau
      description: Switch pour activer/dÃ©sactiver la charge depuis le rÃ©seau (ex. switch.enphase_battery_charge_from_grid)
      selector:
        entity:
          filter:
            - domain: switch

    tempo_today_sensor:
      name: Capteur Tempo Aujourd'hui
      description: Capteur indiquant la couleur Tempo du jour (Bleu/Blanc/Rouge)
      selector:
        entity:
          filter:
            - domain: sensor

    tempo_tomorrow_sensor:
      name: Capteur Tempo Demain
      description: Capteur indiquant la couleur Tempo du lendemain (Bleu/Blanc/Rouge)
      selector:
        entity:
          filter:
            - domain: sensor

    heures_creuses_start:
      name: DÃ©but Heures Creuses
      description: Heure de dÃ©but des heures creuses
      default: "22:30:00"
      selector:
        time:

    heures_creuses_end:
      name: Fin Heures Creuses
      description: Heure de fin des heures creuses
      default: "06:30:00"
      selector:
        time:

    weather_entity:
      name: EntitÃ© MÃ©tÃ©o
      description: EntitÃ© mÃ©tÃ©o pour prÃ©visions (ex. weather.home)
      selector:
        entity:
          filter:
            - domain: weather

    min_soc_charge:
      name: SOC Minimum pour Charge
      description: En-dessous de ce seuil, active la charge en heures creuses (%)
      default: 30
      selector:
        number:
          min: 10
          max: 90
          step: 5
          unit_of_measurement: "%"

    target_soc_normal:
      name: SOC Cible Normal
      description: Niveau de charge cible en heures creuses normales (%)
      default: 80
      selector:
        number:
          min: 50
          max: 100
          step: 5
          unit_of_measurement: "%"

    target_soc_tempo_rouge:
      name: SOC Cible Tempo Rouge
      description: Niveau de charge cible avant un jour rouge Tempo (%)
      default: 100
      selector:
        number:
          min: 80
          max: 100
          step: 5
          unit_of_measurement: "%"

    sunny_forecast_threshold:
      name: Seuil MÃ©tÃ©o EnsoleillÃ©e
      description: Nombre de jours ensoleillÃ©s prÃ©vus pour dÃ©sactiver charge (0 = dÃ©sactivÃ©)
      default: 1
      selector:
        number:
          min: 0
          max: 3
          step: 1

variables:
  battery_soc: !input battery_soc_sensor
  tempo_today: !input tempo_today_sensor
  tempo_tomorrow: !input tempo_tomorrow_sensor
  weather: !input weather_entity
  min_soc: !input min_soc_charge
  target_normal: !input target_soc_normal
  target_rouge: !input target_soc_tempo_rouge
  sunny_threshold: !input sunny_forecast_threshold

trigger:
  # DÃ©clenchement Ã  chaque changement de SOC
  - platform: state
    entity_id: !input battery_soc_sensor

  # DÃ©clenchement au dÃ©but des heures creuses
  - platform: time
    at: !input heures_creuses_start

  # DÃ©clenchement Ã  la fin des heures creuses
  - platform: time
    at: !input heures_creuses_end

  # DÃ©clenchement quand Tempo aujourd'hui change
  - platform: state
    entity_id: !input tempo_today_sensor

  # DÃ©clenchement quand Tempo demain change
  - platform: state
    entity_id: !input tempo_tomorrow_sensor

  # DÃ©clenchement Ã  18h pour vÃ©rifier Tempo lendemain
  - platform: time
    at: "18:00:00"

condition: []

action:
  - choose:
      # CAS 0: BLOQUAGE - Jour rouge Tempo AUJOURD'HUI â†’ JAMAIS de charge depuis rÃ©seau
      - conditions:
          - condition: or
            conditions:
              - condition: state
                entity_id: !input tempo_today_sensor
                state: "RED"
              - condition: state
                entity_id: !input tempo_today_sensor
                state: "Rouge"
              - condition: state
                entity_id: !input tempo_today_sensor
                state: "red"
        sequence:
          - service: switch.turn_off
            target:
              entity_id: !input charge_from_grid_switch
          - service: notify.notify
            data:
              title: "ğŸ”´ Batterie - Jour Rouge Tempo"
              message: "Charge dÃ©sactivÃ©e (jour rouge = tarif Ã©levÃ©)"

      # CAS 1: Heures creuses + Tempo ROUGE demain â†’ Charge forcÃ©e Ã  100%
      - conditions:
          - condition: time
            after: !input heures_creuses_start
            before: !input heures_creuses_end
          - condition: or
            conditions:
              - condition: state
                entity_id: !input tempo_tomorrow_sensor
                state: "RED"
              - condition: state
                entity_id: !input tempo_tomorrow_sensor
                state: "Rouge"
              - condition: state
                entity_id: !input tempo_tomorrow_sensor
                state: "red"
          - condition: numeric_state
            entity_id: !input battery_soc_sensor
            below: !input target_soc_tempo_rouge
        sequence:
          - service: switch.turn_on
            target:
              entity_id: !input charge_from_grid_switch
          - service: notify.notify
            data:
              title: "ğŸ”´ Batterie - Charge Tempo Rouge"
              message: "Charge activÃ©e (Tempo Rouge demain) â†’ Cible {{ target_rouge }}%"

      # CAS 2: Heures creuses + SOC bas + mÃ©tÃ©o dÃ©favorable â†’ Charge normale
      - conditions:
          - condition: time
            after: !input heures_creuses_start
            before: !input heures_creuses_end
          - condition: numeric_state
            entity_id: !input battery_soc_sensor
            below: !input target_soc_normal
          - condition: template
            value_template: >
              {% set forecast = state_attr(weather, 'forecast') %}
              {% if forecast is not none and forecast|length > 0 %}
                {% set sunny_days = forecast[:sunny_threshold]|selectattr('condition', 'in', ['sunny', 'partlycloudy'])|list|length %}
                {{ sunny_days < sunny_threshold }}
              {% else %}
                true
              {% endif %}
        sequence:
          - service: switch.turn_on
            target:
              entity_id: !input charge_from_grid_switch
          - service: notify.notify
            data:
              title: "âš¡ Batterie - Charge Heures Creuses"
              message: "Charge activÃ©e (SOC {{ states(battery_soc) }}%) â†’ Cible {{ target_normal }}%"

      # CAS 3: SOC critique (< min_soc) â†’ Charge forcÃ©e mÃªme hors heures creuses
      - conditions:
          - condition: numeric_state
            entity_id: !input battery_soc_sensor
            below: !input min_soc_charge
        sequence:
          - service: switch.turn_on
            target:
              entity_id: !input charge_from_grid_switch
          - service: notify.notify
            data:
              title: "âš ï¸ Batterie - Charge d'Urgence"
              message: "SOC critique {{ states(battery_soc) }}% - Charge activÃ©e"

      # CAS 4: Hors heures creuses OU cible atteinte â†’ DÃ©sactiver charge
      - conditions:
          - condition: or
            conditions:
              - condition: not
                conditions:
                  - condition: time
                    after: !input heures_creuses_start
                    before: !input heures_creuses_end
              - condition: numeric_state
                entity_id: !input battery_soc_sensor
                above: !input target_soc_normal
        sequence:
          - service: switch.turn_off
            target:
              entity_id: !input charge_from_grid_switch

mode: single
max_exceeded: silent
